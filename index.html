<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブラックジャック (Firebase同期版)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a6332; color: white; text-align: center; padding-top: 20px; }
        h1, h2 { margin: 5px 0; text-shadow: 2px 2px 4px #000; }
        .dealer-area, .player-area, #game-setup { background-color: #0c7c3f; border-radius: 10px; padding: 10px; margin: 10px auto; max-width: 800px; border: 2px solid #ffc107; }
        .players-container { display: flex; justify-content: space-around; max-width: 900px; margin: 20px auto; }
        .player-area { width: 31%; border-color: transparent; transition: border-color 0.3s, box-shadow 0.3s; }
        .player-area.active { border-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; min-height: 120px; }
        .card { background-color: white; color: black; border: 1px solid #333; border-radius: 8px; width: 60px; height: 90px; margin: 3px; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-size: 1.2em; font-weight: bold; box-shadow: 2px 2px 4px rgba(0,0,0,0.4); position: relative; }
        .card.hidden { background-color: #b71c1c; color: #b71c1c; }
        .card.red { color: red; }
        .card .suit:last-child { align-self: flex-end; transform: rotate(180deg); }
        .actions button { font-size: 1.2em; padding: 12px 25px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; background-color: #ffc107; color: #000; font-weight: bold; transition: background-color 0.3s; }
        .actions button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #message-area { font-size: 1.5em; font-weight: bold; height: 40px; margin-top: 10px; color: #ffeb3b; }
        .player-status { font-weight: bold; color: #ffeb3b; min-height: 24px; }
        #game-container, #game-setup { max-width: 900px; margin: 20px auto; }
        #game-container { display: none; }
        input { font-size: 1em; padding: 8px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .betting-controls button { font-size: 0.8em; padding: 5px 8px; margin: 2px; }
    </style>
</head>
<body>
    <h1>ブラックジャック - オンライン対戦</h1>

    <div id="game-setup">
        <h2>ゲームに参加</h2>
        <div><input type="text" id="player-name-input" placeholder="あなたの名前を入力"></div>
        <div><button id="create-game-btn">新しいゲームを作成</button></div>
        <hr>
        <div>
            <input type="text" id="game-id-input" placeholder="6桁のゲームIDを入力して参加">
            <button id="join-game-btn">ゲームに参加</button>
        </div>
    </div>
    
    <div id="game-container">
        <div id="message-area">参加者を待っています...</div>

        <div class="dealer-area">
            <h2>ディーラー: <span id="dealer-score-el"></span></h2>
            <div id="dealer-cards-el" class="card-container"></div>
        </div>

        <div id="players-container" class="players-container"></div>

        <div class="actions">
            <button id="next-round-btn" style="display: none;">次のラウンドへ</button>
            <button id="hit-btn" disabled>ヒット</button>
            <button id="stand-btn" disabled>スタンド</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, get, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0D7fOnIvQFU3O29q6bb_6gj5tWN23N0s",
            authDomain: "memory-game-10e98.firebaseapp.com",
            databaseURL: "https://memory-game-10e98-default-rtdb.firebaseio.com",
            projectId: "memory-game-10e98",
            storageBucket: "memory-game-10e98.firebasestorage.app",
            messagingSenderId: "435852264433",
            appId: "1:435852264433:web:0ef957830b634b9eb13a50",
            measurementId: "G-8GN7P9PFX7"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let localPlayerId = null, gameRef = null, gameState = {};
        
        const messageEl = document.getElementById('message-area');
        const dealerScoreEl = document.getElementById('dealer-score-el');
        const dealerCardsEl = document.getElementById('dealer-cards-el');
        const playersContainer = document.getElementById('players-container');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const hitBtn = document.getElementById('hit-btn');
        const standBtn = document.getElementById('stand-btn');
        const gameSetupDiv = document.getElementById('game-setup');
        const gameContainerDiv = document.getElementById('game-container');
        const playerNameInput = document.getElementById('player-name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');

        function getScore(hand) {
            let score = 0, aceCount = 0;
            if(!hand) return 0;
            for (let card of hand) { if (card.rank === 'A') { aceCount++; score += 11; } else if (['K', 'Q', 'J'].includes(card.rank)) { score += 10; } else { score += parseInt(card.rank); } }
            while (score > 21 && aceCount > 0) { score -= 10; aceCount--; }
            return score;
        }
        function createCardElement(card, isHidden = false) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            if (isHidden) { cardEl.classList.add('hidden'); return cardEl; }
            const isRed = card.suit === '♥' || card.suit === '♦';
            if (isRed) cardEl.classList.add('red');
            cardEl.innerHTML = `<span class="suit">${card.suit}</span><span>${card.rank}</span><span class="suit">${card.suit}</span>`;
            return cardEl;
        }
        function generateRoomId() { return Math.floor(100000 + Math.random() * 900000).toString(); }
        
        createGameBtn.addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) { alert('名前を入力してください。'); return; }
            localPlayerId = `player_${Date.now()}`;
            let newGameId;
            let gameExists = true;
            while(gameExists) { newGameId = generateRoomId(); const snapshot = await get(ref(database, `games/${newGameId}`)); if (!snapshot.exists()) gameExists = false; }
            
            gameRef = ref(database, `games/${newGameId}`);
            const initialGameState = {
                gameId: newGameId,
                status: 'waiting',
                dealer: { hand: [] },
                players: { [localPlayerId]: { id: localPlayerId, name: playerName, chips: 100, isHost: true } },
                playerOrder: [localPlayerId],
                currentPlayerKey: null
            };
            await set(gameRef, initialGameState);
            setupGameListener(newGameId);
        });
        joinGameBtn.addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            const gameId = gameIdInput.value.trim();
            if (!playerName || !gameId) { alert('名前とゲームIDを入力してください。'); return; }
            const existingGameRef = ref(database, `games/${gameId}`);
            const snapshot = await get(existingGameRef);
            if (snapshot.exists()) {
                const gameData = snapshot.val();
                if (Object.keys(gameData.players || {}).length >= 3) { alert('このゲームは満員です。'); return; }
                if (gameData.status !== 'waiting') { alert('このゲームは既に始まっています。'); return; }
                
                localPlayerId = `player_${Date.now()}`;
                const updates = {};
                updates[`/players/${localPlayerId}`] = { id: localPlayerId, name: playerName, chips: 100 };
                updates['/playerOrder'] = [...(gameData.playerOrder || []), localPlayerId];
                await update(existingGameRef, updates);
                setupGameListener(gameId);
            } else { alert('指定されたゲームIDが見つかりません。'); }
        });
        function setupGameListener(gameId) {
            gameSetupDiv.style.display = 'none';
            gameContainerDiv.style.display = 'block';
            gameRef = ref(database, `games/${gameId}`);
            onDisconnect(ref(database, `games/${gameId}/players/${localPlayerId}`)).remove();
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) { alert("ホストが退出しました。"); window.location.reload(); return; }
                const oldState = gameState;
                gameState = snapshot.val();
                renderGame();
                const localPlayer = gameState.players?.[localPlayerId];
                if (localPlayer?.isHost) {
                    if (gameState.status === 'betting' && gameState.players && Object.values(gameState.players).every(p => p.status === 'ready' || p.chips === 0)) {
                        dealCards();
                    }
                    if (gameState.status === 'playing' && gameState.players && Object.values(gameState.players).every(p => p.status !== 'playing')) {
                        update(gameRef, { status: 'dealer_turn' });
                    }
                    if (gameState.status === 'dealer_turn' && oldState.status !== 'dealer_turn') {
                        setTimeout(dealerTurn, 1000);
                    }
                }
            });
        }
        
        nextRoundBtn.addEventListener('click', () => {
            const playerUpdates = {};
            Object.values(gameState.players).forEach(p => {
                playerUpdates[p.id] = { ...p, hand: [], score: 0, bet: 0, status: p.chips > 0 ? 'betting' : 'out' };
            });
            update(gameRef, {
                status: 'betting',
                dealer: { hand: [] },
                players: playerUpdates,
                currentPlayerKey: null,
                message: "ベットしてください"
            });
        });
        async function dealCards() {
            const suits = ['♠','♥','♦','♣'], ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            let newDeck = [];
            for (let i=0; i<4; i++) for (let s of suits) for (let r of ranks) newDeck.push({suit:s, rank:r});
            for (let i = newDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]]; }
            const updates = { status: 'playing', deck: newDeck, message: '' };
            const playerUpdates = { ...gameState.players };
            for(const pid in playerUpdates) { playerUpdates[pid].chips -= playerUpdates[pid].bet; }
            updates.dealer = { hand: [] };
            for(let i=0; i<2; i++) {
                for(const pid of gameState.playerOrder) if(playerUpdates[pid].status === 'ready') playerUpdates[pid].hand.push(updates.deck.pop());
                updates.dealer.hand.push(updates.deck.pop());
            }
            for(const pid in playerUpdates) {
                if(playerUpdates[pid].status === 'ready') {
                    playerUpdates[pid].score = getScore(playerUpdates[pid].hand);
                    playerUpdates[pid].status = playerUpdates[pid].score === 21 ? 'blackjack' : 'playing';
                }
            }
            updates.players = playerUpdates;
            updates.currentPlayerKey = gameState.playerOrder.find(pid => playerUpdates[pid].status === 'playing');
            await update(gameRef, updates);
        }
        hitBtn.addEventListener('click', async () => {
            const newCard = gameState.deck.pop();
            const newHand = [...gameState.players[localPlayerId].hand, newCard];
            const newScore = getScore(newHand);
            const updates = {};
            updates[`/players/${localPlayerId}/hand`] = newHand;
            updates[`/players/${localPlayerId}/score`] = newScore;
            if (newScore > 21) updates[`/players/${localPlayerId}/status`] = 'bust';
            updates['/deck'] = gameState.deck;
            await update(gameRef, updates);
            if(newScore > 21 && gameState.players[localPlayerId]?.isHost) setTimeout(nextPlayerTurn, 500);
        });
        standBtn.addEventListener('click', () => {
            update(ref(database, `games/${gameState.gameId}/players/${localPlayerId}`), { status: 'stand' });
            if (gameState.players[localPlayerId]?.isHost) setTimeout(nextPlayerTurn, 500);
        });
        function nextPlayerTurn() {
            if (!gameState.players[localPlayerId]?.isHost) return;
            const order = gameState.playerOrder;
            const currentIndex = order.indexOf(gameState.currentPlayerKey);
            let nextPlayerKey = null;
            for (let i = 1; i < order.length; i++) {
                const checkIndex = (currentIndex + i) % order.length;
                if(gameState.players[order[checkIndex]]?.status === 'playing'){
                    nextPlayerKey = order[checkIndex];
                    break;
                }
            }
            update(gameRef, { currentPlayerKey: nextPlayerKey });
        }
        async function dealerTurn() {
             const dealerScore = getScore(gameState.dealer?.hand);
            if (dealerScore < 17 && gameState.deck?.length > 0) {
                const newCard = gameState.deck.pop();
                const newHand = [...gameState.dealer.hand, newCard];
                await update(gameRef, { 'dealer/hand': newHand, deck: gameState.deck });
                setTimeout(dealerTurn, 800);
            } else {
                determineWinner();
            }
        }
        function determineWinner() {
            const dealerScore = getScore(gameState.dealer.hand);
            const updates = { status: 'finished', message: `ディーラーのスコア: ${dealerScore}` };
            const playerUpdates = { ...gameState.players };
            Object.values(playerUpdates).forEach(p => {
                if (p.status === 'blackjack') { p.chips += p.bet * 2.5; } 
                else if (p.status === 'stand') {
                    if (dealerScore > 21 || p.score > dealerScore) { p.chips += p.bet * 2; } 
                    else if (p.score === dealerScore) { p.chips += p.bet; }
                }
            });
            updates.players = playerUpdates;
            update(gameRef, updates);
        }

        function renderGame() {
            if (!gameState || !localPlayerId) return;
            const players = gameState.players || {};
            const localPlayer = players[localPlayerId];
            messageEl.textContent = gameState.message || '';
            
            const revealDealer = gameState.status === 'dealer_turn' || gameState.status === 'finished';
            dealerCardsEl.innerHTML = '';
            
            // ★エラー修正: オプショナルチェイニング `?.` を使い、gameState.dealer が存在しない場合にエラーになるのを防ぐ
            (gameState.dealer?.hand || []).forEach((card, index) => dealerCardsEl.appendChild(createCardElement(card, index === 1 && !revealDealer)));
            dealerScoreEl.textContent = revealDealer ? getScore(gameState.dealer?.hand) : getScore([gameState.dealer?.hand?.[0]].filter(Boolean));
            
            playersContainer.innerHTML = '';
            (gameState.playerOrder || []).forEach(pid => {
                const p = players[pid];
                if(!p) return;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-area';
                if (gameState.currentPlayerKey === p.id && gameState.status === 'playing') playerDiv.classList.add('active');
                const betControls = (gameState.status === 'betting' && p.id === localPlayerId && p.status === 'betting') ? `
                    <div class="betting-controls">
                        <button onclick="window.updateBet(10)">+10</button>
                        <button onclick="window.updateBet(50)">+50</button>
                        <button onclick="window.updateBet(100)">+100</button>
                        <button onclick="window.clearBet()">クリア</button>
                        <button onclick="window.confirmBet()">ベット確定</button>
                    </div>` : '';
                playerDiv.innerHTML = `
                    <h2>${p.name} ${p.id === localPlayerId ? '(あなた)' : ''}</h2>
                    <p>Score: <span>${p.score || 0}</span></p>
                    <p>Chips: <span>${p.chips || 0}</span></p>
                    <p>Bet: <span>${p.bet || 0}</span></p>
                    <div class="card-container">${(p.hand || []).map(card => createCardElement(card).outerHTML).join('')}</div>
                    <p class="player-status">${p.status || ''}</p>
                    ${betControls}`;
                playersContainer.appendChild(playerDiv);
            });

            const canDeal = localPlayer?.isHost && (gameState.status === 'waiting' || gameState.status === 'finished');
            nextRoundBtn.style.display = canDeal ? 'inline-block' : 'none';
            nextRoundBtn.disabled = !players || Object.keys(players).length === 0;
            const isMyTurn = gameState.currentPlayerKey === localPlayerId && gameState.status === 'playing';
            hitBtn.disabled = !isMyTurn;
            standBtn.disabled = !isMyTurn;
            if (gameState.status === 'waiting' && gameState.gameId) messageEl.textContent = `参加者: ${Object.keys(players).length}人... ID: ${gameState.gameId}`;
        }

        window.updateBet = (amount) => {
            const player = gameState.players[localPlayerId];
            const newBet = (player.bet || 0) + amount;
            if (newBet <= player.chips) {
                update(ref(database, `games/${gameState.gameId}/players/${localPlayerId}`), { bet: newBet });
            } else { alert('チップが足りません！'); }
        };
        window.clearBet = () => { update(ref(database, `games/${gameState.gameId}/players/${localPlayerId}`), { bet: 0 }); };
        window.confirmBet = () => {
            const player = gameState.players[localPlayerId];
            if ((player.bet || 0) > 0) {
                update(ref(database, `games/${gameState.gameId}/players/${localPlayerId}`), { status: 'ready' });
            } else { alert('ベットしてください。'); }
        };
    </script>
</body>
</html>
